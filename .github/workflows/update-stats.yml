name: æ›´æ–°é¡¹ç›®ç»Ÿè®¡

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    - cron: '0 2 * * *'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ç»Ÿè®¡é¡¹ç›®èµ„æº
      run: |
        echo "# ğŸ“Š é¡¹ç›®ç»Ÿè®¡æŠ¥å‘Š" > STATS.md
        echo "" >> STATS.md
        echo "æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> STATS.md
        echo "" >> STATS.md
        
        # ç»Ÿè®¡æ¨¡æ¿æ•°é‡
        TEMPLATE_COUNT=$(find templates/ -name "*.md" -not -name "README.md" | wc -l)
        echo "## ğŸ“‹ CLAUDE.md æ¨¡æ¿: $TEMPLATE_COUNT ä¸ª" >> STATS.md
        echo "" >> STATS.md
        find templates/ -name "*.md" -not -name "README.md" | while read file; do
          name=$(basename "$file" .md)
          echo "- $name" >> STATS.md
        done
        echo "" >> STATS.md
        
        # ç»Ÿè®¡æ–œæ å‘½ä»¤
        COMMAND_COUNT=$(find examples/slash-commands/ -name "*.md" | wc -l)
        echo "## âš¡ æ–œæ å‘½ä»¤: $COMMAND_COUNT ä¸ª" >> STATS.md
        echo "" >> STATS.md
        find examples/slash-commands/ -type d -mindepth 1 | while read dir; do
          category=$(basename "$dir")
          count=$(find "$dir" -name "*.md" | wc -l)
          echo "- $category: $count ä¸ªå‘½ä»¤" >> STATS.md
        done
        echo "" >> STATS.md
        
        # ç»Ÿè®¡ Hooks
        HOOK_COUNT=$(find examples/hooks/ -name "*.md" | wc -l)
        echo "## ğŸ”§ Hooks é…ç½®: $HOOK_COUNT ä¸ª" >> STATS.md
        echo "" >> STATS.md
        find examples/hooks/ -type d -mindepth 1 | while read dir; do
          category=$(basename "$dir")
          count=$(find "$dir" -name "*.md" | wc -l)
          echo "- $category: $count ä¸ªé…ç½®" >> STATS.md
        done
        echo "" >> STATS.md
        
        # ç»Ÿè®¡æ–‡æ¡£æ–‡ä»¶
        DOC_COUNT=$(find . -name "*.md" | wc -l)
        echo "## ğŸ“š æ–‡æ¡£æ–‡ä»¶: $DOC_COUNT ä¸ª" >> STATS.md
        echo "" >> STATS.md
        
        # ç»Ÿè®¡æ€»è¡Œæ•°
        TOTAL_LINES=$(find . -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
        echo "## ğŸ“ æ€»æ–‡æ¡£è¡Œæ•°: $TOTAL_LINES è¡Œ" >> STATS.md
        echo "" >> STATS.md
        
        # æ£€æŸ¥é“¾æ¥
        echo "## ğŸ”— é“¾æ¥æ£€æŸ¥" >> STATS.md
        BROKEN_LINKS=0
        find . -name "*.md" -exec grep -H "http[s]*://" {} \; | while read line; do
          url=$(echo "$line" | grep -oE 'https?://[^)]*' | head -1)
          if [ -n "$url" ]; then
            if ! curl -L --output /dev/null --silent --head --fail "$url"; then
              echo "âŒ $url" >> STATS.md
              BROKEN_LINKS=$((BROKEN_LINKS + 1))
            fi
          fi
        done
        if [ $BROKEN_LINKS -eq 0 ]; then
          echo "âœ… æ‰€æœ‰é“¾æ¥æœ‰æ•ˆ" >> STATS.md
        fi
        
        echo "" >> STATS.md
        echo "---" >> STATS.md
        echo "*æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> STATS.md
    
    - name: æ£€æŸ¥æ›´æ”¹
      id: verify-changed-files
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: æäº¤ç»Ÿè®¡æ›´æ–°
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add STATS.md
        git commit -m "è‡ªåŠ¨æ›´æ–°é¡¹ç›®ç»Ÿè®¡ ğŸ¤–"
        git push